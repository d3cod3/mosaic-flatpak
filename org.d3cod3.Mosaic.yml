app-id: org.d3cod3.Mosaic
runtime: org.freedesktop.Platform
runtime-version: '20.08'
sdk: org.freedesktop.Sdk
command: mosaic
# rename-icon: accessories-dictionary
finish-args:
  # X11 + XShm access
  - --share=ipc
  - --socket=x11
  # Wayland access
  - --socket=wayland
  # Needs to talk to the network:
  - --share=network
  # Needs to save files locally
  - --filesystem=host
# cleanup:
#  - /include
add-extensions:
    org.freedesktop.Platform.ffmpeg-full:
      directory: lib/ffmpeg
      version: 20.08
      add-ld-path: .
      no-autodownload: true
      autodelete: false

modules:
# openFrameworks dependencies
  - shared-modules/glew/glew.json
  - shared-modules/gtk2/gtk2.json
  - name: freeglut
    buildsystem: cmake-ninja
    config-opts:
      - -DCMAKE_INSTALL_LIBDIR=/app/lib
    sources:
      - type: archive
        url: "https://sourceforge.net/projects/freeglut/files/freeglut/3.2.1/freeglut-3.2.1.tar.gz/download"
        md5: cd5c670c1086358598a6d4a9d166949d
        
  - name: libxmu
    sources:
      - type: archive
        url: https://www.x.org/archive//individual/lib/libXmu-1.1.3.tar.bz2
        sha256: 9c343225e7c3dc0904f2122b562278da5fed639b1b5e880d25111561bac5b731
        
  - name: libraw1394
    rm-configure: true
    sources:
      - type: archive
        url: https://www.kernel.org/pub/linux/libs/ieee1394/libraw1394-2.1.2.tar.xz
        sha256: 03ccc69761d22c7deb1127fc301010dd13e70e44bb7134b8ff0d07590259a55e
      - type: script
        commands: 
         - autoreconf -fiv
      - dest-filename: autogen.sh
      
  - name: freeimage
    buildsystem: simple
    build-commands:
      - sh gensrclist.sh
      - sh genfipsrclist.sh
      - make -f Makefile.gnu -j $FLATPAK_BUILDER_N_JOBS
      - make -f Makefile.fip -j $FLATPAK_BUILDER_N_JOBS
      - make -f Makefile.gnu INCDIR=/app/include INSTALLDIR=/app/lib install
      - make -f Makefile.fip INCDIR=/app/include INSTALLDIR=/app/lib install
    sources:
      - type: archive
        url: https://downloads.sourceforge.net/project/freeimage/Source%20Distribution/3.18.0/FreeImage3180.zip
        sha256: f41379682f9ada94ea7b34fe86bf9ee00935a3147be41b6569c9605a53e438fd
      - type: shell
        commands:
          - sed -i 's/-o root -g root //g' Makefile.{gnu,fip}

  - name: opencv
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - "-DCMAKE_BUILD_TYPE=Release"
      - "-DOPENCV_GENERATE_PKGCONFIG=ON"
      - "-DBUILD_LIST=tracking"
    cleanup:
      - "/bin"
    sources:
      - type: archive
        url: https://github.com/opencv/opencv/archive/4.3.0.tar.gz
        sha256: 68bc40cbf47fdb8ee73dfaf0d9c6494cd095cf6294d99de445ab64cf853d278a
      - type: archive
        url: https://github.com/opencv/opencv_contrib/archive/4.3.0.tar.gz
        sha256: acb8e89c9e7d1174e63e40532125b60d248b00e517255a98a419d415228c6a55

  - name: assimp
    buildsystem: cmake-ninja
    config-opts:
      - -DASSIMP_BUILD_ASSIMP_TOOLS:BOOL=NO
      - -DASSIMP_BUILD_TESTS:BOOL=NO
    sources:
      - type: archive
        url: https://github.com/assimp/assimp/archive/v4.1.0.tar.gz
        sha256: 3520b1e9793b93a2ca3b797199e16f40d61762617e072f2d525fad70f9678a71

  - name: rtaudio
    config-opts:
    - "--disable-static"
    - "--enable-shared"
    sources:
    - type: archive
      url: http://www.music.mcgill.ca/~gary/rtaudio/release/rtaudio-5.1.0.tar.gz
      sha256: ff138b2b6ed2b700b04b406be718df213052d4c952190280cf4e2fab4b61fe09

  - name: boost
    buildsystem: simple
    build-commands:
      - mkdir -p /app/include/boost
      - mv -t /app/include/boost *
    sources:
      - type: archive
        url: https://dl.bintray.com/boostorg/release/1.72.0/source/boost_1_72_0.tar.bz2
        sha256: 59c9b274bc451cf91a9ba1dd2c7fdcaf5d60b1b3aa83f2c9fa143417cc660722

  - name: glfw
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
    - "-DCMAKE_BUILD_TYPE=RelWithDebInfo"
    - "-DBUILD_SHARED_LIBS:BOOL=ON"
    sources:
    - type: archive
      url: https://github.com/glfw/glfw/releases/download/3.3.2/glfw-3.3.2.zip
      sha256: 08a33a512f29d7dbf78eab39bd7858576adcc95228c9efe8e4bc5f0f3261efc7
    cleanup:
    - "/include"
    - "/lib/pkgconfig"

  - name: liburiparser
    buildsystem: cmake
    config-opts:
    - "-DURIPARSER_BUILD_DOCS=OFF"
    - "-DURIPARSER_BUILD_TESTS=OFF"
    cleanup:
    - "/bin/uriparse"
    sources:
    - type: archive
      url: https://github.com/uriparser/uriparser/releases/download/uriparser-0.9.4/uriparser-0.9.4.tar.bz2
      sha256: b7cdabe5611408fc2c3a10f8beecb881a0c7e93ff669c578cd9e3e6d64b8f87b

  - name: pugixml
    buildsystem: cmake-ninja
    build-options:
      cflags: "-fPIC"
      cxxflags: "-fPIC"
    sources:
    - type: archive
      url: https://github.com/zeux/pugixml/releases/download/v1.10/pugixml-1.10.tar.gz
      sha256: 55f399fbb470942410d348584dc953bcaec926415d3462f471ef350f29b5870a

  - name: poco
    buildsystem: cmake
    sources:
    - type: archive
      url: https://github.com/pocoproject/poco/archive/poco-1.10.1-release.tar.gz
      sha256: 44592a488d2830c0b4f3bfe4ae41f0c46abbfad49828d938714444e858a00818

  - name: openframeworks
    buildsystem: make
    sources:
      - type: archive
        url: https://openframeworks.cc/versions/v0.11.0/of_v0.11.0_linux64gcc6_release.tar.gz
        sha256: 513cee3ce081e79fdc1a942af09869145fff3d7addeee0a76cef26fbc3ae69b1
